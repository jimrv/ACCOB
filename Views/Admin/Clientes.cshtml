@model ACCOB.ViewModels.ClienteListViewModel 
@{
    ViewData["Title"] = "Gestión de Clientes";
    var zonaPeru = TimeZoneInfo.FindSystemTimeZoneById("SA Pacific Standard Time");
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-5">
                    <i class="bi bi-person-lines-fill"></i> Gestión de Clientes
                </h1>
                <p class="text-muted">Lista de clientes registrados y sus asesores asignados</p>
            </div>
            <div class="d-flex gap-2 align-items-start">
                <button type="button" onclick="generarReporte()" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel"></i> Generar Reporte
                </button>

                <a asp-action="CrearCliente" class="btn btn-primary">
                    <i class="bi bi-person-plus"></i> Registrar Nuevo Cliente
                </a>
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver al Panel
                </a>
            </div>
        </div>
    </div>

    @* --- SECCIÓN DE FILTROS --- *@
    <div class="card shadow mb-4">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="bi bi-funnel"></i> Filtros de búsqueda</h6>
        </div>
        <div class="card-body">
            <form id="filterForm" method="get" asp-action="Clientes" class="row g-3">
                <div class="col-md-2">
                    <label class="form-label small">Nombre/DNI</label>
                    <input type="text" name="nombre" value="@Model.Nombre" class="form-control form-control-sm" />
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Estado</label>
                    <select name="estado" class="form-select form-select-sm">
                        <option value="">Todos</option>
                        <option value="Pendiente" selected="@(Model.Estado == "Pendiente")">Pendiente</option>
                        <option value="En Gestión" selected="@(Model.Estado == "En Gestión")">En Gestión</option>
                        <option value="Cerrado" selected="@(Model.Estado == "Cerrado")">Cerrado</option>
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label class="form-label small">Provincia</label>
                    <input type="text" name="provincia" value="@Model.Provincia" class="form-control form-control-sm" placeholder="Buscar provincia..." />
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Distrito</label>
                    <input type="text" name="distrito" value="@Model.Distrito" class="form-control form-control-sm" placeholder="Buscar distrito..." />
                </div>

                <div class="col-md-2">
                    <label class="form-label small">Asesor</label>
                    <select name="asesorId" class="form-select form-select-sm">
                        <option value="">Todos</option>
                        <option value="sin_asignar" selected="@(Model.AsesorId == "sin_asignar")">-- Sin Asignar --</option>
                        @foreach (var item in (SelectList)ViewBag.Asesores)
                        {
                            <!option value="@item.Value" @(Model.AsesorId == item.Value ? "selected" : "")>@item.Text</!option>
                        }
                    </select>
                </div>
                
                <div class="col-md-2 d-flex align-items-end gap-1">
                    <button type="submit" class="btn btn-dark btn-sm w-100"><i class="bi bi-search"></i> Filtrar</button>
                    <a asp-action="Clientes" class="btn btn-outline-secondary btn-sm w-100"><i class="bi bi-x-circle"></i> Limpiar</a>
                </div>
            </form>
        </div>
    </div>

    @* --- TABLA Y ACCIÓN MASIVA --- *@
    <form id="bulkAssignForm" asp-action="AsignarAsesorMasivo" method="post">
        @Html.AntiForgeryToken()

        @* Barra de Acción Masiva *@
        <div class="card shadow mb-3 border-primary">
            <div class="card-body py-2 bg-light d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
                    <span class="text-primary fw-bold">
                        <i class="bi bi-check-all"></i>
                        <span id="contadorSeleccionados" class="badge bg-primary">0</span> Seleccionados:
                    </span>
                    <select name="asesorId" id="bulkAsesorId" class="form-select form-select-sm" style="width: 250px;"
                        required>
                        <option value="">-- Seleccionar Asesor Destino --</option>
                        @foreach (var asesor in (SelectList)ViewBag.Asesores)
                        {
                            <option value="@asesor.Value">@asesor.Text</option>
                        }
                    </select>
                    <button type="button" onclick="confirmarAsignacionMasiva()" class="btn btn-primary btn-sm">
                        Asignar Seleccionados
                    </button>
                </div>
                <small class="text-muted">Selecciona los clientes en la tabla para asignarlos de golpe.</small>
            </div>
        </div>

        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-striped" id="tablaClientes">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAll" class="form-check-input"
                                        title="Seleccionar todos" />
                                </th>
                                <th>Fecha Reg.</th>
                                <th>DNI</th>
                                <th>Nombre Cliente</th>
                                <th>Contacto</th>
                                <th>Dirección</th>
                                <th>Estado</th>
                                <th>Asesor Asignado</th>
                                <th>Gestión</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Clientes != null && Model.Clientes.Any())
                            {
                                @foreach (var cliente in Model.Clientes)
                                {
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="clientesSeleccionados" value="@cliente.Id"
                                                class="form-check-input client-checkbox" />
                                        </td>
                                        <td>
                                            @TimeZoneInfo.ConvertTimeFromUtc(cliente.FechaRegistro,
                                            zonaPeru).ToString("dd/MM/yyyy HH:mm")
                                </td>
                                <td><strong>@cliente.Dni</strong></td>
                                <td>@cliente.NombreCompleto</td>
                                <td>
                                    <div class="small"><i class="bi bi-envelope"></i> @cliente.Email</div>
                                    <div class="small"><i class="bi bi-telephone"></i> @cliente.Telefono</div>
                                    
                                </td>
                                <td>
                                    <div class="small fw-bold"><i class="bi bi-geo-alt"></i> @cliente.Distrito, @cliente.Provincia</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">@cliente.Direccion</div>
                                </td>
                                <td>
                                    <span class="badge @(cliente.Estado == "Cerrado" ? "bg-success" : 
                                                        cliente.Estado == "En Gestión" ? "bg-info text-dark" : 
                                                        "bg-warning text-dark")">
                                        @cliente.Estado
                                    </span>
                                </td>
                                <td>
                                    @* Select individual (mantiene el onchange para cambios rápidos) *@
                                    <select class="form-select form-select-sm"
                                        onchange="asignarIndividual(@cliente.Id, this.value)">
                                        <option value="">-- Sin asignar --</option>
                                        @foreach (var asesor in (SelectList)ViewBag.Asesores)
                                                {
                                                    <!option value="@asesor.Value" @(cliente.AsesorId == asesor.Value ? "selected" :
                                                                                                                               "")>
                                                        @asesor.Text
                                                    </!option>
                                                }
                                            </select>
                                        </td>
                                        <td><button type="button" class="btn btn-sm btn-outline-info"
                                                onclick="verHistorial(@cliente.Id)" title="Ver Historial">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group">
                                                <a href="#" class="btn btn-sm btn-outline-primary" title="Editar">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <button type="button" class="btn btn-sm btn-outline-danger"
                                                    onclick="eliminarCliente(@cliente.Id, '@cliente.Nombre')" title="Eliminar">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="9" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox fs-2 d-block mb-2"></i> No se encontraron clientes
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </form>
</div>

@* Formularios ocultos para acciones individuales vía JS *@
<form id="formAsignarIndividual" asp-action="AsignarAsesor" method="post" style="display:none;">
    <input type="hidden" name="clienteId" id="indivClienteId" />
    <input type="hidden" name="asesorId" id="indivAsesorId" />
</form>

<form id="formEliminarCliente" asp-action="EliminarCliente" method="post" style="display:none;">
    <input type="hidden" name="id" id="deleteClienteId" />
</form>

<div class="row mt-3">
    <div class="col-12">
        <div class="alert alert-info py-2">
            <i class="bi bi-info-circle"></i>
            <strong>Total encontrados:</strong> @(Model.Clientes?.Count() ?? 0)
        </div>
    </div>
</div>

<div class="modal fade" id="modalHistorial" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="bi bi-clock-history"></i> Historial de Gestiones</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="contenidoHistorial">
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // 1. Reporte Excel con Filtros
        function generarReporte() {
            const form = document.getElementById('filterForm');
            const params = new URLSearchParams(new FormData(form)).toString();
            window.location.href = '@Url.Action("ExportarClientes")?' + params;
        }

        // 2. Lógica de Checkboxes y Contador
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.client-checkbox');
        const contador = document.getElementById('contadorSeleccionados');

        function actualizarContador() {
            const seleccionados = document.querySelectorAll('.client-checkbox:checked').length;
            contador.innerText = seleccionados;

            if (seleccionados > 0) {
                contador.classList.replace('bg-secondary', 'bg-primary');
            } else {
                contador.classList.replace('bg-primary', 'bg-secondary');
            }
        }

        selectAll.addEventListener('change', function () {
            checkboxes.forEach(cb => {
                cb.checked = this.checked;
            });
            actualizarContador();
        });

        checkboxes.forEach(cb => {
            cb.addEventListener('change', actualizarContador);
        });

        // 3. Alerta de Confirmación Masiva
        function confirmarAsignacionMasiva() {
            const seleccionados = document.querySelectorAll('.client-checkbox:checked').length;
            const asesorSelect = document.getElementById('bulkAsesorId');
            const nombreAsesor = asesorSelect.options[asesorSelect.selectedIndex].text;

            if (seleccionados === 0) {
                alert("Por favor, selecciona al menos un cliente de la lista.");
                return;
            }

            if (asesorSelect.value === "") {
                alert("Por favor, selecciona el asesor al que deseas asignar los clientes.");
                return;
            }

            const mensaje = `¿Estás seguro de asignar ${seleccionados} cliente(s) al asesor "${nombreAsesor}"?`;

            if (confirm(mensaje)) {
                document.getElementById('bulkAssignForm').submit();
            }
        }

        // 4. Acciones Individuales
        function asignarIndividual(clienteId, asesorId) {
            document.getElementById('indivClienteId').value = clienteId;
            document.getElementById('indivAsesorId').value = asesorId;
            document.getElementById('formAsignarIndividual').submit();
        }

        function eliminarCliente(id, nombre) {
            if (confirm(`¿Estás seguro de que deseas eliminar al cliente ${nombre}?`)) {
                document.getElementById('deleteClienteId').value = id;
                document.getElementById('formEliminarCliente').submit();
            }
        }

        // 5. Función de Historial con BARRA DE MOVIMIENTO (MODIFICADA)
        function verHistorial(clienteId) {
            const clientesData = @Json.Serialize(Model.Clientes.Select(c => new {
                id = c.Id,
                nombre = c.NombreCompleto,
                venta = c.Ventas.OrderByDescending(v => v.FechaVenta).Select(v => new {
                    zona = v.ZonaNombre,
                    plan = v.PlanNombre,
                    velocidad = v.VelocidadContratada,
                    precio = v.PrecioFinal
                }).FirstOrDefault(),
                llamadas = c.Llamadas.Select(ll => new {
                    fechaLlamada = ll.FechaLlamada,
                    resultado = ll.Resultado,
                    observaciones = ll.Observaciones,
                    nombreAsesor = ll.Asesor != null ? ll.Asesor.Nombre : "Sistema"
                }).ToList()
            }));

            const cliente = clientesData.find(c => c.id === clienteId);
            
            let html = `<h6>Cliente: <strong>${cliente.nombre}</strong></h6><hr>`;
            
            if (cliente.llamadas && cliente.llamadas.length > 0) {
                // AGREGADO: max-height y overflow-y para la barra de movimiento
                html += `<div class="table-responsive" style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6;">
                            <table class="table table-sm table-striped mb-0">
                                <thead class="table-light sticky-top" style="z-index: 10;">
                                    <tr class="small">
                                        <th>Fecha</th>
                                        <th>Asesor</th> 
                                        <th>Resultado</th>
                                        <th>Detalles / Observaciones</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                
                const llamadasOrdenadas = cliente.llamadas.sort((a, b) => new Date(b.fechaLlamada) - new Date(a.fechaLlamada));
                
                llamadasOrdenadas.forEach(ll => {
                    const fecha = new Date(ll.fechaLlamada).toLocaleString('es-PE');
                    
                    let infoPlan = "";
                    if (ll.resultado === "Venta Cerrada" && cliente.venta) {
                        infoPlan = `
                            <div class="mt-2 p-2 border-start border-4 border-success bg-white shadow-sm rounded">
                                <small class="d-block text-success fw-bold text-uppercase" style="font-size: 0.7rem;">
                                    <i class="bi bi-cart-check-fill"></i> Plan Contratado
                                </small>
                                <div class="row g-0 mt-1" style="font-size: 0.85rem;">
                                    <div class="col-12"><strong>Zona:</strong> ${cliente.venta.zona}</div>
                                    <div class="col-12"><strong>Plan:</strong> ${cliente.venta.plan}</div>
                                    <div class="col-12"><strong>Tarifa:</strong> ${cliente.venta.velocidad} - 
                                        <span class="text-success fw-bold">S/ ${cliente.venta.precio.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>`;
                    }

                    html += `<tr class="small">
                                <td class="text-nowrap">${fecha}</td>
                                <td class="fw-bold text-primary">${ll.nombreAsesor}</td> 
                                <td><span class="badge bg-light text-dark border">${ll.resultado}</span></td>
                                <td>
                                    ${infoPlan}
                                    <div class="mt-1 text-muted">${ll.observaciones || '-'}</div>
                                </td>
                            </tr>`;
                });
                html += `</tbody></table></div>`;
            } else {
                html += `<div class="text-center py-4 text-muted">No hay gestiones registradas.</div>`;
            }
            
            document.getElementById('contenidoHistorial').innerHTML = html;
            var myModal = new bootstrap.Modal(document.getElementById('modalHistorial'));
            myModal.show();
        }
    </script>
}