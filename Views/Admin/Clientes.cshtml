@model ACCOB.ViewModels.ClienteListViewModel 
@{
    ViewData["Title"] = "Gestión de Clientes";
    var zonaPeru = TimeZoneInfo.FindSystemTimeZoneById("SA Pacific Standard Time");
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-5">
                    <i class="bi bi-person-lines-fill"></i> Gestión de Clientes
                </h1>
                <p class="text-muted">Lista de clientes registrados y sus asesores asignados</p>
            </div>
            <div class="d-flex gap-2 align-items-start">
                <button type="button" onclick="generarReporte()" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel"></i> Generar Reporte
                </button>

                <a asp-action="CrearCliente" class="btn btn-primary">
                    <i class="bi bi-person-plus"></i> Registrar Nuevo Cliente
                </a>
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver al Panel
                </a>
            </div>
        </div>
    </div>

@* --- SECCIÓN DE FILTROS --- *@
<div class="card shadow mb-4">
    <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-funnel"></i> Filtros de búsqueda</h6>
    </div>
    <div class="card-body">
        <form id="filterForm" method="get" asp-action="Clientes">
            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Nombre/DNI</label>
                    <input type="text" name="nombre" value="@Model.Nombre" class="form-control form-control-sm" placeholder="Ej: 43776539..." />
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold">Estado</label>
                    <select name="estado" class="form-select form-select-sm">
                        <option value="">Todos</option>
                        <option value="Pendiente" selected="@(Model.Estado == "Pendiente")">Pendiente</option>
                        <option value="En Gestión" selected="@(Model.Estado == "En Gestión")">En Gestión</option>
                        <option value="Cerrado" selected="@(Model.Estado == "Cerrado")">Cerrado</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold">Provincia</label>
                    <input type="text" name="provincia" value="@Model.Provincia" class="form-control form-control-sm" placeholder="Buscar provincia..." />
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold">Distrito</label>
                    <input type="text" name="distrito" value="@Model.Distrito" class="form-control form-control-sm" placeholder="Buscar distrito..." />
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Asesor</label>
                    <select name="asesorId" class="form-select form-select-sm">
                        <option value="">Todos los asesores</option>
                        <option value="sin_asignar" selected="@(Model.AsesorId == "sin_asignar")">-- Sin Asignar --</option>
                        @foreach (var item in (SelectList)ViewBag.Asesores)
                        {
                            <!option value="@item.Value" @(Model.AsesorId == item.Value ? "selected" : "")>@item.Text</!option>
                        }
                    </select>
                </div>
            </div>

            <div class="row g-3 align-items-end">
                @* --- Fechas de Gestión --- *@
                <div class="col-md-3">
                    <label class="form-label small fw-bold"><i class="bi bi-calendar-event"></i> Gestión Desde</label>
                    <input type="date" name="fechaGestionInicio" value="@(Model.FechaGestionInicio?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm" />
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold"><i class="bi bi-calendar-check"></i> Gestión Hasta</label>
                    <input type="date" name="fechaGestionFin" value="@(Model.FechaGestionFin?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm" />
                </div>

                @* --- Fechas de Registro --- *@
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Registro Desde</label>
                    <input type="date" name="fechaInicio" value="@(Model.FechaInicio?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm" />
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Registro Hasta</label>
                    <input type="date" name="fechaFin" value="@(Model.FechaFin?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm" />
                </div>
                
                <div class="col-md-2"></div>

                <div class="col-md-4 d-flex gap-2">
                    <button type="submit" class="btn btn-dark btn-sm w-100">
                        <i class="bi bi-search"></i> Aplicar Filtros
                    </button>
                    <a asp-action="Clientes" class="btn btn-outline-secondary btn-sm w-100">
                        <i class="bi bi-x-circle"></i> Limpiar Campos
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

    @* --- TABLA Y ACCIÓN MASIVA --- *@
    <form id="bulkActionForm" method="post">
        @Html.AntiForgeryToken()

        @* Barra de Acción Masiva *@
        <div class="card shadow mb-3 border-primary">
            <div class="card-body py-2 bg-light d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
                    <span class="text-primary fw-bold">
                        <i class="bi bi-check-all"></i>
                        <span id="contadorSeleccionados" class="badge bg-primary">0</span> Seleccionados:
                    </span>
                    
                    @* Grupo Asignación *@
                    <select name="asesorId" id="bulkAsesorId" class="form-select form-select-sm" style="width: 200px;">
                        <option value="">-- Asignar Asesor --</option>
                        @foreach (var asesor in (SelectList)ViewBag.Asesores)
                        {
                            <option value="@asesor.Value">@asesor.Text</option>
                        }
                    </select>
                    <button type="button" onclick="ejecutarAsignacionMasiva()" class="btn btn-primary btn-sm">
                        Asignar
                    </button>

                    <div class="vr mx-2"></div>

                    @* Grupo Eliminación *@
                    <button type="button" onclick="ejecutarEliminacionMasiva()" class="btn btn-danger btn-sm">
                        <i class="bi bi-trash"></i> Eliminar Selección
                    </button>
                </div>
                <small class="text-muted">Acciones rápidas para múltiples clientes.</small>
            </div>
        </div>

        <div class="card shadow">
            <div class="card-body">
                @* Añadimos altura máxima y scroll vertical *@
                <div class="table-responsive" style="max-height: 530px; overflow-y: auto; border: 1px solid #dee2e6;">
                    <table class="table table-hover table-striped mb-0" id="tablaClientes">
                        @* La cabecera se mantendrá fija al hacer scroll *@
                        <thead class="table-dark sticky-top" style="z-index: 1020;">
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAll" class="form-check-input" title="Seleccionar todos" />
                                </th>
                                <th style="width: 5%">Fecha Reg.</th>
                                <th style="width: 5%">DNI</th>
                                <th style="width: 15%">Nombre Cliente</th>
                                <th style="width: 10%">Contacto</th>
                                <th>Ubicación</th>
                                <th >Estado</th>
                                <th>Asesor Asig.</th>
                                <th class="text-center">Gestión</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Clientes != null && Model.Clientes.Any())
                            {
                                foreach (var cliente in Model.Clientes)
                                {
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="clientesSeleccionados" value="@cliente.Id" class="form-check-input client-checkbox" />
                                        </td>
                                        <td>
                                            @TimeZoneInfo.ConvertTimeFromUtc(cliente.FechaRegistro,
                                            zonaPeru).ToString("dd/MM/yyyy HH:mm")
                                        </td>
                                        <td><strong>@cliente.Dni</strong></td>
                                        <td>@cliente.NombreCompleto</td>
                                        <td>
                                            <div class="small"><i class="bi bi-envelope"></i> @cliente.Email</div>
                                            <div class="small"><i class="bi bi-telephone"></i> @cliente.Telefono</div>
                                        </td>
                                        <td>
                                            <div class="small fw-bold"><i class="bi bi-geo-alt"></i> @cliente.Distrito, @cliente.Provincia</div>
                                            <div class="text-muted" style="font-size: 0.75rem;">@cliente.Direccion</div>
                                        </td>
                                        <td>
                                            <span class="badge @(cliente.Estado == "Cerrado" ? "bg-success" : 
                                                                cliente.Estado == "En Gestión" ? "bg-info text-dark" : 
                                                                "bg-warning text-dark")">
                                                @cliente.Estado
                                            </span>
                                        </td>
                                        <td>
                                            @* SELECT INDIVIDUAL - CORREGIDO *@
                                            <select class="form-select form-select-sm" onchange="asignarIndividual(@cliente.Id, this.value)">
                                                <option value="">-- Sin asignar --</option>
                                                @foreach (var asesor in (SelectList)ViewBag.Asesores)
                                                {
                                                    <!option value="@asesor.Value" @(cliente.AsesorId == asesor.Value ? "selected" : "")>
                                                        @asesor.Text
                                                    </!option>
                                                }
                                            </select>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-info" onclick="verHistorial(@cliente.Id)" title="Ver Historial">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarCliente(@cliente.Id, '@cliente.NombreCompleto')" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="10" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox fs-2 d-block mb-2"></i> No se encontraron registros
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </form>
</div>

@* --- FORMULARIOS OCULTOS PARA JS --- *@

@* Formulario para Asignación Individual *@
<form id="formAsignarIndividual" asp-action="AsignarAsesor" method="post" style="display:none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="clienteId" id="indivClienteId" />
    <input type="hidden" name="asesorId" id="indivAsesorId" />
</form>

@* Formulario para Eliminación Individual *@
<form id="formEliminarCliente" asp-action="EliminarCliente" method="post" style="display:none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" id="deleteClienteId" />
</form>

<div class="row mt-3">
    <div class="col-12">
        <div class="alert alert-info py-2">
            <i class="bi bi-info-circle"></i>
            <strong>Total encontrados:</strong> @(Model.Clientes?.Count() ?? 0)
        </div>
    </div>
</div>

@* Modal Historial *@
<div class="modal fade" id="modalHistorial" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="bi bi-clock-history"></i> Historial de Gestiones</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="contenidoHistorial"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // 1. Reporte Excel
        function generarReporte() {
            const form = document.getElementById('filterForm');
            const params = new URLSearchParams(new FormData(form)).toString();
            window.location.href = '@Url.Action("ExportarClientes", "Admin")?' + params;
        }

        // 2. Control de Selección (Checkboxes)
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.client-checkbox');
        const contador = document.getElementById('contadorSeleccionados');

        function actualizarContador() {
            const num = document.querySelectorAll('.client-checkbox:checked').length;
            contador.innerText = num;
            contador.className = num > 0 ? 'badge bg-primary' : 'badge bg-secondary';
        }

        selectAll.addEventListener('change', function () {
            checkboxes.forEach(cb => cb.checked = this.checked);
            actualizarContador();
        });

        checkboxes.forEach(cb => {
            cb.addEventListener('change', actualizarContador);
        });

        // 3. ASIGNACIÓN INDIVIDUAL (El que te fallaba)
        function asignarIndividual(clienteId, asesorId) {
            document.getElementById('indivClienteId').value = clienteId;
            document.getElementById('indivAsesorId').value = asesorId;
            document.getElementById('formAsignarIndividual').submit();
        }

        // 4. ACCIONES MASIVAS
        function ejecutarAsignacionMasiva() {
            const num = document.querySelectorAll('.client-checkbox:checked').length;
            const asesorSelect = document.getElementById('bulkAsesorId');

            if (num === 0) { alert("Selecciona al menos un cliente."); return; }
            if (asesorSelect.value === "") { alert("Selecciona un asesor."); return; }

            if (confirm(`¿Asignar ${num} clientes a ${asesorSelect.options[asesorSelect.selectedIndex].text}?`)) {
                const form = document.getElementById('bulkActionForm');
                form.action = '@Url.Action("AsignarAsesorMasivo")';
                form.submit();
            }
        }

        function ejecutarEliminacionMasiva() {
            const num = document.querySelectorAll('.client-checkbox:checked').length;
            if (num === 0) { alert("Selecciona clientes para eliminar."); return; }

            if (confirm(`¡ATENCIÓN! Se eliminarán ${num} clientes de forma definitiva. ¿Continuar?`)) {
                const form = document.getElementById('bulkActionForm');
                form.action = '@Url.Action("EliminarClientesMasivo")';
                form.submit();
            }
        }

        // 5. ELIMINAR INDIVIDUAL
        function eliminarCliente(id, nombre) {
            if (confirm(`¿Eliminar definitivamente a ${nombre}?`)) {
                document.getElementById('deleteClienteId').value = id;
                document.getElementById('formEliminarCliente').submit();
            }
        }

        // 6. HISTORIAL
        function verHistorial(clienteId) {
            const clientesData = @Json.Serialize(Model.Clientes.Select(c => new {
                id = c.Id,
                nombre = c.NombreCompleto,
                llamadas = c.Llamadas.Select(ll => new {
                    fechaLlamada = ll.FechaLlamada, 
                    resultado = ll.Resultado, 
                    observaciones = ll.Observaciones,
                    nombreAsesor = ll.Asesor != null ? ll.Asesor.Nombre : "Sistema"
                }).ToList(),
                ventas = c.Ventas.Select(v => new {
                    zona = v.ZonaNombre,
                    plan = v.PlanNombre,
                    velocidad = v.VelocidadContratada,
                    precio = v.PrecioFinal,
                    fecha = v.FechaVenta
                }).ToList()
            }));

            const cliente = clientesData.find(c => c.id === clienteId);
            let html = `<h6>Cliente: <strong>${cliente.nombre}</strong></h6><hr>`;

            if (cliente.llamadas && cliente.llamadas.length > 0) {
                // Definimos un contenedor con scroll y altura máxima para aprox. 7 gestiones
                html += `
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light sticky-top" style="z-index: 1;">
                                <tr>
                                    <th style="width: 15%">Fecha</th>
                                    <th style="width: 20%">Asesor</th>
                                    <th style="width: 20%" class="text-center">Resultado</th>
                                    <th style="width: 50%">Detalles / Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>`;

                cliente.llamadas.sort((a, b) => new Date(b.fechaLlamada) - new Date(a.fechaLlamada)).forEach(ll => {
                    const fecha = new Date(ll.fechaLlamada).toLocaleString('es-PE', { 
                        day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' 
                    });
                    
                    let observacionesHtml = `<div class="text-muted" style="font-size: 0.85rem;">${ll.observaciones || '-'}</div>`;

                    if (ll.resultado === "Venta Cerrada") {
                        const venta = cliente.ventas[0]; 
                        if (venta) {
                            observacionesHtml = `
                                <div class="border-start border-success border-4 ps-2 my-2 py-1" style="background-color: #fcfdfc;">
                                    <div class="text-success fw-bold" style="font-size: 0.75rem;">
                                        <i class="bi bi-cart-fill"></i> DATOS DE LA VENTA:
                                    </div>
                                    <div class="small"><strong>Zona:</strong> ${venta.zona}</div>
                                    <div class="small"><strong>Plan:</strong> ${venta.plan}</div>
                                    <div class="small text-success fw-bold"><strong>Tarifa:</strong> ${venta.velocidad} - S/ ${venta.precio}</div>
                                </div>
                                ${observacionesHtml}
                            `;
                        }
                    }

                    let resultadoBadge = ll.resultado === "Venta Cerrada" 
                        ? `<span class="badge rounded-pill bg-success px-3 py-2" style="font-size: 0.75rem;">${ll.resultado}</span>`
                        : `<span class="text-dark small">${ll.resultado}</span>`;

                    html += `
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td class="small align-middle text-muted">${fecha}</td>
                            <td class="small align-middle fw-bold text-primary">${ll.nombreAsesor}</td> 
                            <td class="align-middle text-center">${resultadoBadge}</td>
                            <td class="align-middle">${observacionesHtml}</td>
                        </tr>`;
                });

                html += `</tbody></table></div>`;

                //Contador de gestiones
                html += `
                    <div class="d-flex justify-content-between align-items-center bg-light p-2 border border-top-0 small">
                        <span class="text-muted">
                            <i class="bi bi-info-circle"></i> Deslice para ver más gestiones
                        </span>
                        <span class="badge bg-secondary">
                            Total gestiones: ${cliente.llamadas.length}
                        </span>
                    </div>`;
            } else {
                html += `<div class="text-center py-4 text-muted"><i class="bi bi-chat-dots fs-3 d-block mb-2"></i> Sin gestiones registradas.</div>`;
            }
            
            document.getElementById('contenidoHistorial').innerHTML = html;
            new bootstrap.Modal(document.getElementById('modalHistorial')).show();
        }
    </script>
}